name: ğŸ”’ Security Scanning

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

# ğŸ›¡ï¸ Security: Restrict permissions
permissions:
  actions: read
  contents: read
  security-events: write
  pull-requests: write

# ğŸš« Prevent concurrent runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  # ğŸ” Dependency Scanning
  dependency-scan:
    name: ğŸ” Dependency Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ›¡ï¸ Run npm audit
        id: npm-audit
        run: |
          echo "ğŸ” Running npm security audit..."
          
          # Run audit and capture output
          npm audit --audit-level moderate --json > audit-results.json || true
          
          # Check if there are any vulnerabilities
          VULNS=$(jq '.metadata.vulnerabilities.total' audit-results.json 2>/dev/null || echo "0")
          
          echo "vulnerabilities=$VULNS" >> $GITHUB_OUTPUT
          
          if [ "$VULNS" -gt 0 ]; then
            echo "âš ï¸ Found $VULNS vulnerabilities"
            npm audit --audit-level moderate
          else
            echo "âœ… No vulnerabilities found"
          fi

      - name: ğŸ“Š Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results-${{ github.run_id }}
          path: audit-results.json
          retention-days: 30

      - name: ğŸ” Run Snyk security scan
        continue-on-error: true
        run: |
          echo "ğŸ” Running Snyk security scan..."
          
          # Install Snyk if available
          if npm list -g snyk >/dev/null 2>&1 || npm install -g snyk; then
            echo "Running Snyk scan..."
            snyk test --json > snyk-results.json || true
            
            if [ -f snyk-results.json ]; then
              echo "ğŸ“Š Snyk scan completed"
              cat snyk-results.json | jq -r '.vulnerabilities[].title' | head -10 || true
            fi
          else
            echo "âš ï¸ Snyk not available, skipping scan"
          fi

  # ğŸ” Code Scanning (CodeQL)
  codeql:
    name: ğŸ” CodeQL Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript' ]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: +security-and-quality

      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

  # ğŸ•µï¸ Secret Scanning
  secret-scan:
    name: ğŸ•µï¸ Secret Detection
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ•µï¸ Run TruffleHog secret scan
        run: |
          echo "ğŸ•µï¸ Starting TruffleHog secret scan..."
          
          # Install TruffleHog
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
          
          # Determine scan approach based on context
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ğŸ“‹ PR detected - scanning diff against base branch"
            BASE_REF="${{ github.event.pull_request.base.sha }}"
            HEAD_REF="${{ github.event.pull_request.head.sha }}"
            
            if [ "$BASE_REF" != "$HEAD_REF" ]; then
              echo "ğŸ” Scanning from $BASE_REF to $HEAD_REF"
              trufflehog git file://. --since-commit="$BASE_REF" --only-verified --fail || {
                echo "âš ï¸ TruffleHog found potential secrets in PR changes"
                echo "Please review the findings above"
                exit 1
              }
            else
              echo "âš ï¸ Base and head commits are identical, scanning full repository"
              trufflehog filesystem . --only-verified --fail || {
                echo "âš ï¸ TruffleHog found potential secrets"
                exit 1
              }
            fi
          else
            echo "ğŸ“‚ Push/schedule detected - scanning recent commits"
            # For push events, scan last few commits to avoid scanning entire history
            COMMITS_TO_SCAN=5
            if [ "${{ github.event_name }}" == "push" ]; then
              COMMITS_TO_SCAN="${{ github.event.push.commits.length || 5 }}"
            fi
            
            echo "ğŸ” Scanning last $COMMITS_TO_SCAN commits"
            trufflehog git file://. --max-depth="$COMMITS_TO_SCAN" --only-verified --fail || {
              echo "âš ï¸ TruffleHog found potential secrets in recent commits"
              exit 1
            }
          fi
          
          echo "âœ… TruffleHog scan completed successfully"

      - name: ğŸ” Custom secret patterns scan
        run: |
          echo "ğŸ” Scanning for common secret patterns..."
          
          # Define patterns to search for
          PATTERNS=(
            "(?i)(api_key|apikey|api-key)\s*[:=]\s*['\"][^'\"]{8,}['\"]"
            "(?i)(secret|password|passwd|pwd)\s*[:=]\s*['\"][^'\"]{4,}['\"]"
            "(?i)(token)\s*[:=]\s*['\"][^'\"]{8,}['\"]"
            "(?i)(key)\s*[:=]\s*['\"][^'\"]{8,}['\"]"
            "-----BEGIN [A-Z ]+-----"
            "(?i)chrome-extension://[a-z0-9]{32}"
          )
          
          echo "ğŸ” Searching for potential secrets..."
          FOUND_SECRETS=false
          
          for pattern in "${PATTERNS[@]}"; do
            if grep -rE "$pattern" . --exclude-dir=".git" --exclude-dir="node_modules" --exclude="*.log" >/dev/null 2>&1; then
              echo "âš ï¸ Potential secret pattern found: $pattern"
              FOUND_SECRETS=true
            fi
          done
          
          if [ "$FOUND_SECRETS" = "false" ]; then
            echo "âœ… No suspicious secret patterns found"
          else
            echo "âŒ Potential secrets detected. Please review the codebase."
            exit 1
          fi

  # ğŸ” License Scanning
  license-scan:
    name: ğŸ” License Compliance Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ” Check licenses
        run: |
          echo "ğŸ” Checking license compliance..."
          
          # Install license-checker if not present
          if ! command -v license-checker &> /dev/null; then
            npm install -g license-checker
          fi
          
          # Run license check
          license-checker --summary > license-summary.txt
          license-checker --json > license-details.json
          
          echo "ğŸ“Š License summary:"
          cat license-summary.txt
          
          # Check for prohibited licenses
          PROHIBITED_LICENSES=("GPL-2.0" "AGPL-3.0" "LGPL-2.1")
          
          echo "ğŸ” Checking for prohibited licenses..."
          VIOLATIONS_FOUND=false
          
          for license in "${PROHIBITED_LICENSES[@]}"; do
            if grep -q "$license" license-details.json; then
              echo "âŒ Prohibited license found: $license"
              VIOLATIONS_FOUND=true
            fi
          done
          
          if [ "$VIOLATIONS_FOUND" = "false" ]; then
            echo "âœ… No license violations found"
          else
            echo "âš ï¸ License violations detected. Please review dependencies."
          fi

      - name: ğŸ“¤ Upload license reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: license-reports-${{ github.run_id }}
          path: |
            license-summary.txt
            license-details.json
          retention-days: 30

  # ğŸ”’ Security Policy Check
  security-policy:
    name: ğŸ”’ Security Policy Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”’ Check security files
        run: |
          echo "ğŸ”’ Checking for security policy files..."
          
          SECURITY_FILES=(
            "SECURITY.md"
            ".github/SECURITY.md"
            "docs/SECURITY.md"
            "security.txt"
            ".well-known/security.txt"
          )
          
          FOUND_POLICY=false
          
          for file in "${SECURITY_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found security policy: $file"
              FOUND_POLICY=true
              break
            fi
          done
          
          if [ "$FOUND_POLICY" = "false" ]; then
            echo "âš ï¸ No security policy found"
            echo "ğŸ“ Consider adding a SECURITY.md file"
          fi

      - name: ğŸ” Validate manifest security
        run: |
          echo "ğŸ” Validating Chrome extension security..."
          
          if [ -f "manifest.json" ]; then
            echo "ğŸ“‹ Checking manifest.json security settings..."
            
            # Check for content security policy
            if jq -e '.content_security_policy' manifest.json >/dev/null; then
              echo "âœ… Content Security Policy defined"
            else
              echo "âš ï¸ No Content Security Policy found"
            fi
            
            # Check for excessive permissions
            PERMISSIONS=$(jq -r '.permissions[]?' manifest.json 2>/dev/null | tr '\n' ' ')
            echo "ğŸ” Permissions: $PERMISSIONS"
            
            # Flag potentially dangerous permissions
            DANGEROUS_PERMS=("tabs" "history" "bookmarks" "<all_urls>" "webRequest" "webRequestBlocking")
            
            for perm in "${DANGEROUS_PERMS[@]}"; do
              if echo "$PERMISSIONS" | grep -q "$perm"; then
                echo "âš ï¸ Potentially sensitive permission: $perm"
              fi
            done
            
            echo "âœ… Manifest security check completed"
          else
            echo "âŒ manifest.json not found"
          fi

  # ğŸ“Š Security Report
  security-report:
    name: ğŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, codeql, secret-scan, license-scan, security-policy]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“Š Generate security summary
        run: |
          echo "ğŸ“Š Security Scan Summary"
          echo "========================"
          echo ""
          echo "ğŸ” Dependency Scan: ${{ needs.dependency-scan.result }}"
          echo "ğŸ” CodeQL Analysis: ${{ needs.codeql.result }}"
          echo "ğŸ•µï¸ Secret Scan: ${{ needs.secret-scan.result }}"
          echo "ğŸ” License Scan: ${{ needs.license-scan.result }}"
          echo "ğŸ”’ Security Policy: ${{ needs.security-policy.result }}"
          echo ""
          
          # Count failures
          FAILURES=0
          if [ "${{ needs.dependency-scan.result }}" = "failure" ]; then ((FAILURES++)); fi
          if [ "${{ needs.codeql.result }}" = "failure" ]; then ((FAILURES++)); fi
          if [ "${{ needs.secret-scan.result }}" = "failure" ]; then ((FAILURES++)); fi
          if [ "${{ needs.license-scan.result }}" = "failure" ]; then ((FAILURES++)); fi
          if [ "${{ needs.security-policy.result }}" = "failure" ]; then ((FAILURES++)); fi
          
          if [ $FAILURES -eq 0 ]; then
            echo "ğŸ‰ All security scans passed!"
            echo "âœ… Repository appears to be secure"
          else
            echo "âš ï¸ $FAILURES security scan(s) failed"
            echo "ğŸ” Please review the failed scans above"
          fi

      - name: ğŸ“ Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              dependency: '${{ needs.dependency-scan.result }}',
              codeql: '${{ needs.codeql.result }}',
              secrets: '${{ needs.secret-scan.result }}',
              license: '${{ needs.license-scan.result }}',
              policy: '${{ needs.security-policy.result }}'
            };
            
            const statusEmoji = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'skipped': return 'â­ï¸';
                default: return 'âš ï¸';
              }
            };
            
            const body = `## ğŸ”’ Security Scan Results
            
            | Scan Type | Status | Result |
            |-----------|--------|--------|
            | ğŸ” Dependencies | ${statusEmoji(results.dependency)} | ${results.dependency} |
            | ğŸ” CodeQL | ${statusEmoji(results.codeql)} | ${results.codeql} |
            | ğŸ•µï¸ Secrets | ${statusEmoji(results.secrets)} | ${results.secrets} |
            | ğŸ” Licenses | ${statusEmoji(results.license)} | ${results.license} |
            | ğŸ”’ Policy | ${statusEmoji(results.policy)} | ${results.policy} |
            
            ${Object.values(results).every(r => r === 'success') ? 
              'ğŸ‰ **All security scans passed!** This PR is secure.' : 
              'âš ï¸ **Some security scans need attention.** Please review the failed scans.'}
            
            ---
            *ğŸ›¡ï¸ Automated security report*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });